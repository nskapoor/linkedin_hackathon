<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js">
</script>
<body>
<div id="demo"><h2>Before updating </h2></div>
<button id="btn">Click me</button>

<p id="listdev">Divs will list here!</p>
</body>

<script>

$(document).ready(function() {

        $("#btn").click(function() {
                var url = 'http://www.gizmodo.com';
                glob_onload = 1;
                makeCorsRequest(url);
        });
});


var url = 'http://api.alice.com/cors';
var glob_onload = 0;
//var xhr = createCORSRequest('GET', url);
//xhr.send();
// Create the XHR object.
function createCORSRequest(method, url) {
        var xhr = new XMLHttpRequest();
        if ("withCredentials" in xhr) {
                // XHR for Chrome/Firefox/Opera/Safari.
                xhr.open(method, url, true);
                //xhr.setRequestHeader("Access-Control-Allow-Origin","*");
        } else if (typeof XDomainRequest != "undefined") {
                // XDomainRequest for IE.
                xhr = new XDomainRequest();
                xhr.open(method, url);
        } else {
                // CORS not supported.
                xhr = null;
        }
        return xhr;
}

// Helper method to parse the title tag from the response.
function getTitle(text) {
        return text.match('<title>(.*)?</title>')[1];
}

// Make the actual CORS request.
function makeCorsRequest(url) {
        // All HTML5 Rocks properties support CORS.
    //    var url = 'http://updates.html5rocks.com';

        //var url = 'http://www.bbc.com';
       //var url = 'http://localhost:8000/div.html'

        var xhr = createCORSRequest('GET', url);
        if (!xhr) {
                alert('CORS not supported');
                return;
        }

        // Response handlers.
        xhr.onload = function() {
                var text = xhr.responseText;
                //var title = getTitle(text);
                //alert('Response from CORS request to ' + url + ': ' + title);
                //document.getElementById("demo").innerHTML = text;
                if (glob_onload == 1) {
                        getAllLinks(text);
                } else if (glob_onload == 2) {
                        tts_for_read(text);
                }
        };

        xhr.onerror = function() {
                alert('Woops, there was an error making the request.');
        };

        xhr.send();
}
function tts_for_read(read_response) {

        var ssu1 = new SpeechSynthesisUtterance();
        ssu1.lang = 'en-US';
        ssu1.rate = 0.75;
        //ssu1.onend = timerEnd;

        jQuery("p[data-textannotation-id][class!='has-media media-640']",read_response).each(
        function( index ) {
                console.log("Index:" + index + " " + $(this).text());
                ssu1.text = $(this).text();
                speechSynthesis.speak(ssu1);                
        });
}
function getAllLinks(text) {
        var query = jQuery(text);
        var links = query.find('article');// working
        
        /* Speech Recog logic */
        var recognizing;
        var recognition = new webkitSpeechRecognition();
        recognition.continuous = true;
        recognition.onend = reset();
        recognition.start();
        recognizing = true;

        console.log("length is : " + links.length);
        /* TTS */
        var ssu = new SpeechSynthesisUtterance();
        ssu.lang = 'en-US';
        ssu.rate = 1;
        ssu.onend = speechOnEnd;
        var tts_timer, current_url;

        var current_hdr_index = 0;
       
        /* Invoke the function which actually runs on timer completion. This happens to trigger the tts
         * for titles which will then carry on from there.
         */
        timerEnd();
        
        function speechOnEnd() {
                tts_timer = setTimeout(timerEnd,7000);
        }

        function timerEnd() 
        {
                if (current_hdr_index > 5) {
                        return;
                }
                current_url = $(links[current_hdr_index]).children("header");
                if (current_url.length == 0) {
                        console.log("No header found"); 
                } //else {
                        ssu.text = $(current_url).text();
                        console.log("index and text is: " + current_hdr_index +" " + $(current_url).text());
                        speechSynthesis.speak(ssu);
                //}
                current_hdr_index++;
        }

        recognition.onresult = function (event) {
                console.log("in on result!!");
                var speech = "";
                for (var i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                                speech = speech.concat(event.results[i][0].transcript);
                        }
                }
                console.log("Speech recognised: " + speech);
                if (speech.match(/next/gi)) {
                        console.log("input was next");
                        speechSynthesis.cancel(ssu);
                        /* If next is uttered during the timer delay */
                        clearTimeout(tts_timer);   
                        timerEnd();
                } else if (speech.match(/listen/gi)) {
                        console.log("in listen");
                        clearTimeout(tts_timer);   
                        speechSynthesis.cancel(ssu);
                        read(current_hdr_index);
                }else if (speech.match(/quit/gi)) {
                        console.log("input was quit");
                        clearTimeout(tts_timer);   
                        speechSynthesis.cancel(ssu);
                        if (recognizing) {
                                recognition.stop();
                                reset();
                        }
                }

        }

        function read() {
                console.log("in function read");
                console.log($(current_url).attr('href'));
                var href = $(current_url).find("a");
                console.log("num of hrefs are:" + href.length);
                var href_url = $(href).attr('href');
                console.log("url is: " +href_url);
                glob_onload = 2;
                makeCorsRequest(href_url);
        }


        function reset() {
                recognizing = false;
        }
}


</script>
</html>
